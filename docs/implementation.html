<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-11-23T17:42:51.5922098"><meta name="build-number" content="${buildNumber}">       <title>Implementation | Opponent Search</title><script id="virtual-toc-data" type="application/json">[{"id":"core-classes","level":0,"title":"Core Classes","anchor":"#core-classes"},{"id":"search-agents-implementations","level":0,"title":"Search Agents Implementations","anchor":"#search-agents-implementations"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Implementation | Opponent Search"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="Opponent Search Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="implementation.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Implementation | Opponent Search"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "implementation.html#webpage", "url": "implementation.html", "name": "Implementation | Opponent Search", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "Opponent Search Help" }</script><!-- End Schema.org --> <!-- Mermaid light/dark themes -->  <link rel="stylesheet" type="text/css" href="mermaid.css">  </head>     <body data-id="Implementation" data-main-title="Implementation" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="OpponentSearch-Project.md|OpponentSearch Project"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Opponent Search  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Implementation"  id="Implementation.md"  >Implementation</h1>  <p id="6e05b766_717">The propagation algorithm is implemented in a set of core C++ classes with different search agents that integrate with that core. The core classes handle segment information and computes the fitness function over all segments for a search agent on demand to return the nav path that an agent should use. The search agents use the path</p><section class="chapter"><h2 id="core-classes" data-toc="core-classes">Core Classes</h2><section class="chapter"><h3 id="ucliquehandler" data-toc="ucliquehandler">UCliqueHandler</h3><p id="6e05b766_718">The BCIClique Plu</p></section><section class="chapter"><h3 id="search-agent" data-toc="search-agent">Search Agent</h3></section><section class="chapter"><h3 id="usharedsearchspacesubsystem" data-toc="usharedsearchspacesubsystem">USharedSearchSpaceSubsystem</h3><p id="6e05b766_719">The subsystem which handles all operations over segments for a clique of search agents over an ARecastNavMesh. The lifecycle of the subsystem is scoped to a UWorld, which matches the lifecycle of an ARecastNavMesh. Search agents register with a specific ARecastNavMesh, and all agents are grouped into a set based on their chosen mesh. The subsystem ticks at a given rate and this tick function runs the propagation and check for discovery steps. For performance reasons, this function doesn't tick on every frame.</p><p id="6e05b766_720">This subsystem is the source of truth on segment probabilities. A search agent looking for a</p></section><section class="chapter"><h3 id="fsharedsearchspacelogicrecastqueryfilter" data-toc="fsharedsearchspacelogicrecastqueryfilter">FSharedSearchSpaceLogicRecastQueryFilter</h3><p id="6e05b766_721">This struct computes the cost of traversing a recast navmesh poly using a snapshot of the probability. The filter is a virtual filter which runs at a very frequent rate, so all costs are cached instead of updating live.</p><p id="6e05b766_722">This filter is used in 2 ways:</p><ol class="list _decimal" id="6e05b766_723"  type="1"  ><li class="list__item" id="6e05b766_724"><p>Sum all probabilities for every segment on a path</p></li><li class="list__item" id="6e05b766_725"><p>Compute the cost of moving along a path with the detour algorithm</p></li></ol></section><section class="chapter"><h3 id="detection" data-toc="detection">Detection</h3><p id="6e05b766_726">All Search Agents approximate a sight cone with a Box. While cones are possible, approximating with a box is simple. Once a point is culled with the box, we line trace.</p></section></section><section class="chapter"><h2 id="search-agents-implementations" data-toc="search-agents-implementations">Search Agents Implementations</h2><p id="6e05b766_727">There are</p><section class="chapter"><h3 id="native-c" data-toc="native-c">Native C++</h3><p id="6e05b766_728">The native C++ implementation search agent uses no blueprints or in-editor workflows. Instead, it directly uses navigation components and the USharedSearchSpaceSubsystem to dispatch AIMove requests with callbacks to implement the patrol gameplay behavior.</p><p id="6e05b766_729">Pro:</p><ul class="list _ul" id="6e05b766_730"    ><li class="list__item" id="6e05b766_731"><p>Only requires C++ knowledge</p></li><li class="list__item" id="6e05b766_732"><p>Simple for gameplay engineers to use and modify</p></li><li class="list__item" id="6e05b766_733"><p>Directly uses the navigation system for faster performance</p></li><li class="list__item" id="6e05b766_734"><p>Callbacks provide flexible hooks for other classes</p></li></ul><p id="6e05b766_735">Con:</p><ul class="list _ul" id="6e05b766_736"    ><li class="list__item" id="6e05b766_737"><p>Doesn't use the managed Behavior Tree AI approach</p></li><li class="list__item" id="6e05b766_738"><p>Gameplay AI specialists may not be comfortable with C++</p></li><li class="list__item" id="6e05b766_739"><p>Difficult to implement complicated behavior with callbacks</p></li></ul><section class="chapter"><h4 id="unativesharedsearchspacelogiccomponent" data-toc="unativesharedsearchspacelogiccomponent">UNativeSharedSearchSpaceLogicComponent</h4><p id="6e05b766_740">This component is responsible for calling functions on the USharedSearchSpaceSubsystem and AIController components to managed move requests. A single move request may traverse anywhere from 0 to an uncapped number of segments depending on the state of the segments and the pathfinding outcomes. Requests are async and execute on the next frame. This is because the fitness function may determine that the best waypoint is located within the acceptance radius of the move request, which will cause the navigation system to immediately succeed. Improperly handling this case results in infinite loops or stack overflow as callbacks spin on requesting to move to the same point forever.</p><p id="6e05b766_741">When an agent successfully reaches a target segment, they will attempt to find another segment to move to. This movement is subject to the 180 degree constraint, and if the movement requires a 180-degree rotation then the request terminates. Otherwise, the agent will immediately take the next path without stopping. This process can repeat indefinitely, so an unobstructed search agent can navigate the space without ever stopping until the navigation is explicitly halted by another mechanism.</p></section><section class="chapter"><h4 id="upatrolsharedsearchspacecomponent" data-toc="upatrolsharedsearchspacecomponent">UPatrolSharedSearchSpaceComponent</h4><p id="6e05b766_742">This component wraps the UNativeSharedSearchSpaceLogicComponent into a &quot;patrol&quot; behavior for the search agent. Currently, all this does is halt the agent in place for a few seconds when the 180-degree rotation case occurs before resuming movement, but conceivably this component could be expanded to include gameplay cues like animating the guards yawning, stretching their limbs, pausing to look at their watch, or myriad other behaviors for gameplay or immersion purposes.</p></section></section><section class="chapter"><h3 id="behavior-tree" data-toc="behavior-tree">Behavior Tree</h3><p id="6e05b766_743">The Behavior Tree search agent implementation uses the managed Unreal AI features:</p><ul class="list _ul" id="6e05b766_744"    ><li class="list__item" id="6e05b766_745"><p>Behavior Trees</p></li><li class="list__item" id="6e05b766_746"><p>Blackboards</p></li><li class="list__item" id="6e05b766_747"><p>Environment Query System (EQS)</p></li></ul><p id="6e05b766_748">This approach is suitable for production use of the Shared Search Space navigation system. By integrating with Unreal's AI system, search behavior becomes a subcomponent of an agent's AI implementation.</p><p id="6e05b766_749">Pros:</p><ul class="list _ul" id="6e05b766_750"    ><li class="list__item" id="6e05b766_751"><p>Integrates with the managed AI framework</p></li><li class="list__item" id="6e05b766_752"><p>Simple for gameplay AI engineers to use</p></li><li class="list__item" id="6e05b766_753"><p>Behavior can be modified without C++</p></li><li class="list__item" id="6e05b766_754"><p>Implementation is split into smaller re-usable task and EQS nodes</p></li></ul><p id="6e05b766_755">Cons:</p><ul class="list _ul" id="6e05b766_756"    ><li class="list__item" id="6e05b766_757"><p>Slower than a native C++ implementation</p></li><li class="list__item" id="6e05b766_758"><p>C++ engineers may not be familiar with Behavior Trees</p></li><li class="list__item" id="6e05b766_759"><p>Functional testing Behavior Trees is difficult</p></li></ul><section class="chapter"><h4 id="uenvquerygenerator-sharedsearchspacenodes" data-toc="uenvquerygenerator-sharedsearchspacenodes">UEnvQueryGenerator_SharedSearchSpaceNodes</h4><p id="6e05b766_760">Query to get all nav points on an ARecastNavMesh, then score them using the fitness function.</p></section><section class="chapter"><h4 id="uenvquerytest-sharedsearchspace" data-toc="uenvquerytest-sharedsearchspace">UEnvQueryTest_SharedSearchSpace</h4></section><section class="chapter"><h4 id="ubttask-sharedsearchspacemove" data-toc="ubttask-sharedsearchspacemove">UBTTask_SharedSearchSpaceMove</h4></section></section></section><div class="last-modified"> Last modified: 24 November 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="patrol-algorithm.html">Patrol Algorithm</a>   <a class="navigation-links__next" href="optimizations.html">Optimizations</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.js"></script></body></html>