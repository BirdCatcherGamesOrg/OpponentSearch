<!DOCTYPE html SYSTEM "about:legacy-compat"><html lang="en-US" data-colors-preset="contrast" data-primary-color="#307FFF"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="robots" content="noindex">  <meta name="built-on" content="2023-11-23T13:13:19.7798479"><meta name="build-number" content="${buildNumber}">       <title>Patrol Algorithm | Opponent Search</title><script id="virtual-toc-data" type="application/json">[{"id":"probability-diffusion","level":0,"title":"Probability Diffusion","anchor":"#probability-diffusion"},{"id":"gameplay-considerations","level":0,"title":"Gameplay Considerations","anchor":"#gameplay-considerations"}]</script><script id="topic-shortcuts" type="application/json"></script><link href="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.css" rel="stylesheet">   <link rel="apple-touch-icon" sizes="180x180" href="https://jetbrains.com/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="https://jetbrains.com/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="https://jetbrains.com/favicon-16x16.png"><link rel="manifest" href="https://jetbrains.com/site.webmanifest"><link rel="mask-icon" href="https://jetbrains.com/safari-pinned-tab.svg" color="#000000"><meta name="msapplication-TileColor" content="#000000"/><meta name="msapplication-TileImage" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-144x144.png"/><meta name="msapplication-square70x70logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-70x70.png"/><meta name="msapplication-square150x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-150x150.png"/><meta name="msapplication-wide310x150logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x150.png"/><meta name="msapplication-square310x310logo" content="https://resources.jetbrains.com/storage/ui/favicons/mstile-310x310.png"/>  <meta name="image" content=""><!-- Open Graph --><meta property="og:title" content="Patrol Algorithm | Opponent Search"/><meta property="og:description" content=""/><meta property="og:image" content=""/><meta property="og:site_name" content="Opponent Search Help"/><meta property="og:type" content="website"/><meta property="og:locale" content="en_US"/><meta property="og:url" content="patrol-algorithm.html"/><!-- End Open Graph --><!-- Twitter Card --><meta name="twitter:card" content="summary_large_image"><meta name="twitter:site" content=""><meta name="twitter:title" content="Patrol Algorithm | Opponent Search"><meta name="twitter:description" content=""><meta name="twitter:creator" content=""><meta name="twitter:image:src" content=""><!-- End Twitter Card --><!-- Schema.org WebPage --><script type="application/ld+json"> { "@context": "http://schema.org", "@type": "WebPage", "@id": "patrol-algorithm.html#webpage", "url": "patrol-algorithm.html", "name": "Patrol Algorithm | Opponent Search", "description": "", "image": "", "inLanguage":"en-US" }</script><!-- End Schema.org --><!-- Schema.org WebSite --><script type="application/ld+json"> { "@type": "WebSite", "@id": "/#website", "url": "/", "name": "Opponent Search Help" }</script><!-- End Schema.org --> <!-- Mermaid light/dark themes -->  <link rel="stylesheet" type="text/css" href="mermaid.css">  </head>     <body data-id="Patrol-Algorithm" data-main-title="Patrol Algorithm" data-article-props="{&quot;seeAlsoStyle&quot;:&quot;links&quot;}"  data-template="article"  data-breadcrumbs="OpponentSearch-Project.md|OpponentSearch Project"  >   <div class="wrapper"><main class="panel _main"><header class="panel__header"><div class="container"><h3>Opponent Search  Help</h3><div class="panel-trigger"></div></div></header><section class="panel__content"><div class="container"><article class="article" data-shortcut-switcher="inactive"><h1 data-toc="Patrol-Algorithm"  id="Patrol-Algorithm.md"  >Patrol Algorithm</h1>  <section class="chapter"><h2 id="probability-diffusion" data-toc="probability-diffusion">Probability Diffusion</h2><p id="a3b0d836_39">The foundation of the patrol algorithm is the Probability Diffusion approach in the paper. This page documents modifications to that algorithm which have improved the gameplay experience in practice.</p><section class="chapter"><h3 id="total-path-consideration" data-toc="total-path-consideration">Total Path Consideration</h3><p id="a3b0d836_40">The fitness function in the paper only considers the probability of the segment at the end of a path. Stale segments are almost always adjacent to each other. When only the endpoint is considered, search agents have a tendency to stale neighboring segments. This results in 2 emergent behaviors:</p><ol class="list _decimal" id="a3b0d836_41"  type="1"  ><li class="list__item" id="a3b0d836_42"><p>Search agents will converge from across the map to visit a small cluster of stale segments which all neighbor each other.</p></li><li class="list__item" id="a3b0d836_43"><p>Search agents synchronize into a single file when stale segments are co-linear. </p><ul class="list _ul" id="a3b0d836_44"    ><li class="list__item" id="a3b0d836_45"><p>This behavior is very hard to break. Forcing agents to pick new points results in choosing the segment further down the line.</p></li></ul></li></ol><p id="a3b0d836_46">To mitigate this the fitness function must sum the probability of all segments along the navigation path. This biases search agents to choose long paths which traverse many stale segments instead of frequently traversed paths with only one stale segment at the very end. In addition, this causes agents to &quot;spread out&quot; from each other since stale paths rarely overlap.</p><p id="a3b0d836_47">By considering the entire path, the average staleness across all points is reduced even further and the distance between guards results in a more balanced gameplay experience.</p></section></section><section class="chapter"><h2 id="gameplay-considerations" data-toc="gameplay-considerations">Gameplay Considerations</h2><p id="a3b0d836_48">The patrol algorithm needs to be modified to handle gameplay requirements. Without these modifications, the gameplay experience is unbalanced and/or immersion breaking.</p><section class="chapter"><h3 id="planned-halting" data-toc="planned-halting">Planned Halting</h3><p id="a3b0d836_49">Left to their own devices, search agents can patrol indefinitely, seamlessly picking new segments to move to every time they reach their current destination. In practice, this is exhausting for players because they never get the opportunity to relax, nor get the satisfaction of disabling an opponent who has temporarily let their guard down. To mitigate this, there should be cases where guards stop moving as part of the algorithm or as random events like yawning, radioing in an update or other tropes of stealth games.</p><p id="a3b0d836_50">Any halts in the agents' movement must also include a sight line check so that the agent doesn't stand in place facing a wall. The agent must ray trace ahead, and if it collides with a wall, the agent should rotate a small amount until they find an open sight line.</p></section><section class="chapter"><h3 id="short-path-filtering" data-toc="short-path-filtering">Short Path Filtering</h3><p id="a3b0d836_51">Sometimes the best fit segment is located very close to the search agent. This can lead to the agent taking a single step but with a broad rotation to bring the waypoint into view. While this is correct behavior from an algorithmic standpoint, it is uncanny and breaks immersion.</p><p id="a3b0d836_52">Sometimes the best fit segment can be so close to the search agent that it falls inside its current movement acceptance radius so the navigation system will return synchronously. The rest of the gameplay code may not expect this, and it is easy to accidentally write callbacks which loop infinite or cause stack overflows in such cases.</p><p id="a3b0d836_53">To mitigate these issues, it is recommended that search agents filter out any segments which are located &quot;too close&quot; to the search agent. There's no hard definition, but in practice one or two times to acceptance radius of the search agent yields acceptable results.</p></section><section class="chapter"><h3 id="corner-avoidance" data-toc="corner-avoidance">Corner Avoidance</h3><p id="a3b0d836_54">Oftentimes the most stale segments are located in areas with very few open sight lines. In practice this means that search agents will move towards corners and the end of long hallways. While this is good for keeping the overall staleness of the search space down, this makes the game too easy. A guard in the corner of the map is much less likely to see the player because they lack sight lines out of these points.</p><p id="a3b0d836_55">To mitigate this, levels should be designed to minimize the number of corners or narrow hallways. Uninteresting corners should be removed from the ARecastNavMesh used to build the viz-mesh, or adjusted so the cost of entering a &quot;boring&quot; area is too high.</p></section><section class="chapter"><h3 id="180-degree-rotation-prevention" data-toc="180-degree-rotation-prevention">180-Degree Rotation Prevention</h3><p id="a3b0d836_56">Stealth gameplay centers on quietly following patrollers and disabling them. If search agents are able to pivot 180 degrees, then the player may be spotted during their approach. Players feel that this is unfair, and it ruins the gameplay loop. Unfortunately, oftentimes the most stale point happens to be somewhere behind the current position of the search agent which can result in a 180-degree rotation.</p><p id="a3b0d836_57">To mitigate this, AI agents check if the next point on their navigation path requires a 180-degree turn. Two options for alternative patrol behavior were evaluated.</p><section class="chapter"><h4 id="first-angle-filtering-recommended" data-toc="first-angle-filtering-recommended">First Angle Filtering (Recommended)</h4><p id="a3b0d836_58">In this approach, the search agent filters out any endpoints where the desired path begins with a 180-degree turn. If no such path exists, then the agent will halt in place for a short period of time before resuming movement. After this pause, the 180-degree restriction is lifted since the player had enough time to change their course.</p></section><section class="chapter"><h4 id="halt-in-place-not-recommended" data-toc="halt-in-place-not-recommended">Halt in Place (Not Recommended)</h4><p id="a3b0d836_59">In this approach, the search agent always stops in place.</p><p id="a3b0d836_60">This halting behavior has several drawbacks:</p><ol class="list _decimal" id="a3b0d836_61"  type="1"  ><li class="list__item" id="a3b0d836_62"><p>Search agents often stand still facing the wall in front of them which breaks immersion and makes the game too easy.</p></li><li class="list__item" id="a3b0d836_63"><p>The behavior is predictable. Whenever an agent stands still, players quickly catch on that they will rotate 180 degrees on their next move.</p></li><li class="list__item" id="a3b0d836_64"><p>&quot;Stutter steps&quot; occurs when the agent's next navigation point is discovered shortly after a new point is acquired. The root cause is this: </p><ol class="list _decimal" id="a3b0d836_65"  type="1"  ><li class="list__item" id="a3b0d836_66"><p>The agent reaches their current destination. The next destination requires a 180-degree turn, so they halt.</p></li><li class="list__item" id="a3b0d836_67"><p>The agent picks their next navigation path, which still requires a 180-degree rotation.</p></li><li class="list__item" id="a3b0d836_68"><p>Immediately after moving, the point that the agent chooses to move to is discovered by another agent. The agent chooses a new path, which requires another 180-degree turn, so the agent halts.</p></li><li class="list__item" id="a3b0d836_69"><p>Repeated many times, the agent rotates in place, taking 1 step in each direction between halts.</p></li></ol></li></ol></section></section></section><div class="last-modified"> Last modified: 23 November 2023</div><div data-feedback-placeholder="true"></div><div class="navigation-links _bottom">  <a class="navigation-links__prev" href="radar.html">Radar</a>   <a class="navigation-links__next" href="implementation.html">Implementation</a>  </div></article><div id="disqus_thread"></div></div></section></main></div>  <script src="https://resources.jetbrains.com/writerside/apidoc/6.1.5-b176/app.js"></script></body></html>